<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>AOF 持久化的实现 &mdash; Redis 设计与实现</title>
    
    <link rel="stylesheet" href="../../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Redis 设计与实现" href="../../index.html" /> 

<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->


  </head>
  <body>


    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../index.html">Redis 设计与实现</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="aof">
<h1>AOF 持久化的实现<a class="headerlink" href="#aof" title="Permalink to this headline">¶</a></h1>
<p>AOF 持久化功能的实现可以分为命令追加（append）、文件写入、文件同步（sync）三个步骤。</p>
<div class="section" id="id1">
<h2>命令追加<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>当 AOF 持久化功能处于打开状态时，
服务器在执行完一个写命令之后，
会以协议格式将被执行的写命令追加到服务器状态的 <code class="docutils literal"><span class="pre">aof_buf</span></code> 缓冲区的末尾：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">struct</span> <span class="n">redisServer</span> <span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="c1">// AOF 缓冲区</span>
    <span class="n">sds</span> <span class="n">aof_buf</span><span class="p">;</span>

    <span class="c1">// ...</span>
<span class="p">};</span>
</pre></div>
</div>
<p>举个例子，
如果客户端向服务器发送以下命令：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">redis</span><span class="o">&gt;</span> <span class="n">SET</span> <span class="n">KEY</span> <span class="n">VALUE</span>
<span class="n">OK</span>
</pre></div>
</div>
<p>那么服务器在执行这个 <span class="xref std std-ref">SET</span> 命令之后，
会将以下协议内容追加到 <code class="docutils literal"><span class="pre">aof_buf</span></code> 缓冲区的末尾：</p>
<div class="highlight-c"><div class="highlight"><pre>*3\r\n$3\r\nSET\r\n$3\r\nKEY\r\n$5\r\nVALUE\r\n
</pre></div>
</div>
<p>又比如说，
如果客户端向服务器发送以下命令：</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">redis</span><span class="o">&gt;</span> <span class="n">RPUSH</span> <span class="n">NUMBERS</span> <span class="n">ONE</span> <span class="n">TWO</span> <span class="n">THREE</span>
<span class="p">(</span><span class="n">integer</span><span class="p">)</span> <span class="mi">3</span>
</pre></div>
</div>
<p>那么服务器在执行这个 <span class="xref std std-ref">RPUSH</span> 命令之后，
会将以下协议内容追加到 <code class="docutils literal"><span class="pre">aof_buf</span></code> 缓冲区的末尾：</p>
<div class="highlight-c"><div class="highlight"><pre>*5\r\n$5\r\nRPUSH\r\n$7\r\nNUMBERS\r\n$3\r\nONE\r\n$3\r\nTWO\r\n$5\r\nTHREE\r\n
</pre></div>
</div>
<p>以上就是 AOF 持久化的命令追加步骤的实现原理。</p>
</div>
<div class="section" id="id2">
<h2>AOF 文件的写入与同步<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Redis 的服务器进程就是一个事件循环（loop），
这个循环中的文件事件负责接收客户端的命令请求，
以及向客户端发送命令回复，
而时间事件则负责执行像 <code class="docutils literal"><span class="pre">serverCron</span></code> 函数这样需要定时运行的函数。</p>
<p>因为服务器在处理文件事件时可能会执行写命令，
使得一些内容被追加到 <code class="docutils literal"><span class="pre">aof_buf</span></code> 缓冲区里面，
所以在服务器每次结束一个事件循环之前，
它都会调用 <code class="docutils literal"><span class="pre">flushAppendOnlyFile</span></code> 函数，
考虑是否需要将 <code class="docutils literal"><span class="pre">aof_buf</span></code> 缓冲区中的内容写入和保存到 AOF 文件里面，
这个过程可以用以下伪代码表示：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">eventLoop</span><span class="p">():</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

        <span class="c"># 处理文件事件，接收命令请求以及发送命令回复</span>
        <span class="c"># 处理命令请求时可能会有新内容被追加到 aof_buf 缓冲区中</span>
        <span class="n">processFileEvents</span><span class="p">()</span>

        <span class="c"># 处理时间事件</span>
        <span class="n">processTimeEvents</span><span class="p">()</span>

        <span class="c"># 考虑是否要将 aof_buf 中的内容写入和保存到 AOF 文件里面</span>
        <span class="n">flushAppendOnlyFile</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">flushAppendOnlyFile</span></code> 函数的行为由服务器配置的 <code class="docutils literal"><span class="pre">appendfsync</span></code> 选项的值来决定，
各个不同值产生的行为如表 TABLE_APPENDFSYNC 所示。</p>
<table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><code class="docutils literal"><span class="pre">appendfsync</span></code> 选项的值</th>
<th class="head"><code class="docutils literal"><span class="pre">flushAppendOnlyFile</span></code> 函数的行为</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">always</span></code></td>
<td>将 <code class="docutils literal"><span class="pre">aof_buf</span></code> 缓冲区中的所有内容写入并同步到 AOF 文件。</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">everysec</span></code></td>
<td>将 <code class="docutils literal"><span class="pre">aof_buf</span></code> 缓冲区中的所有内容写入到 AOF 文件，
如果上次同步 AOF 文件的时间距离现在超过一秒钟，
那么再次对 AOF 文件进行同步，
并且这个同步操作是由一个线程专门负责执行的。</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">no</span></code></td>
<td>将 <code class="docutils literal"><span class="pre">aof_buf</span></code> 缓冲区中的所有内容写入到 AOF 文件，
但并不对 AOF 文件进行同步，
何时同步由操作系统来决定。</td>
</tr>
</tbody>
</table>
<p>如果用户没有主动为 <code class="docutils literal"><span class="pre">appendfsync</span></code> 选项设置值，
那么 <code class="docutils literal"><span class="pre">appendfsync</span></code> 选项的默认值为 <code class="docutils literal"><span class="pre">everysec</span></code> ，
关于 <code class="docutils literal"><span class="pre">appendfsync</span></code> 选项的更多信息，
请参考 Redis 项目附带的示例配置文件 <code class="docutils literal"><span class="pre">redis.conf</span></code> 。</p>
<div class="topic">
<p class="topic-title first">文件的写入和同步</p>
<p>为了提高文件的写入效率，
在现代操作系统中，
当用户调用 <code class="docutils literal"><span class="pre">write</span></code> 函数，
将一些数据写入到文件的时候，
操作系统通常会将写入数据暂时保存在一个内存缓冲区里面，
等到缓冲区的空间被填满、或者超过了指定的时限之后，
才真正地将缓冲区中的数据写入到磁盘里面。</p>
<p>这种做法虽然提高了效率，
但也为写入数据带来了安全问题，
因为如果计算机发生停机，
那么保存在内存缓冲区里面的写入数据将会丢失。</p>
<p>为此，
系统提供了 <code class="docutils literal"><span class="pre">fsync</span></code> 和 <code class="docutils literal"><span class="pre">fdatasync</span></code> 两个同步函数，
它们可以强制让操作系统立即将缓冲区中的数据写入到硬盘里面，
从而确保写入数据的安全性。</p>
</div>
<p>举个例子，
假设服务器在处理文件事件期间，
执行了以下三个写入命令：</p>
<ol class="arabic simple">
<li><code class="docutils literal"><span class="pre">SADD</span> <span class="pre">databases</span> <span class="pre">&quot;Redis&quot;</span> <span class="pre">&quot;MongoDB&quot;</span> <span class="pre">&quot;MariaDB&quot;</span></code></li>
<li><code class="docutils literal"><span class="pre">SET</span> <span class="pre">date</span> <span class="pre">&quot;2013-9-5&quot;</span></code></li>
<li><code class="docutils literal"><span class="pre">INCR</span> <span class="pre">click_counter</span> <span class="pre">10086</span></code></li>
</ol>
<p>那么 <code class="docutils literal"><span class="pre">aof_buf</span></code> 缓冲区将包含这三个命令的协议内容：</p>
<div class="highlight-c"><div class="highlight"><pre>*5\r\n$4\r\nSADD\r\n$9\r\ndatabases\r\n$5\r\nRedis\r\n$7\r\nMongoDB\r\n$7\r\nMariaDB\r\n
*3\r\n$3\r\nSET\r\n$4\r\ndate\r\n$8\r\n2013-9-5\r\n
*3\r\n$4\r\nINCR\r\n$13\r\nclick_counter\r\n$5\r\n10086\r\n
</pre></div>
</div>
<p>如果这时 <code class="docutils literal"><span class="pre">flushAppendOnlyFile</span></code> 函数被调用，
假设服务器当前 <code class="docutils literal"><span class="pre">appendfsync</span></code> 选项的值为 <code class="docutils literal"><span class="pre">everysec</span></code> ，
并且根据 <code class="docutils literal"><span class="pre">server.aof_last_fsync</span></code> 属性显示，
距离上次同步 AOF 文件已经超过一秒钟，
那么服务器会先将 <code class="docutils literal"><span class="pre">aof_buf</span></code> 中的内容写入到 AOF 文件中，
然后再对 AOF 文件进行同步。</p>
<p>以上就是对 AOF 持久化功能的文件写入和文件同步这两个步骤的介绍。</p>
<div class="topic">
<p class="topic-title first">AOF 持久化的效率和安全性</p>
<p>服务器配置 <code class="docutils literal"><span class="pre">appendfsync</span></code> 选项的值直接决定 AOF 持久化功能的效率和安全性。</p>
<p>当 <code class="docutils literal"><span class="pre">appendfsync</span></code> 的值为 <code class="docutils literal"><span class="pre">always</span></code> 时，
服务器在每个事件循环都要将 <code class="docutils literal"><span class="pre">aof_buf</span></code> 缓冲区中的所有内容写入到 AOF 文件，
并且同步 AOF 文件，
所以 <code class="docutils literal"><span class="pre">always</span></code> 的效率是 <code class="docutils literal"><span class="pre">appendfsync</span></code> 选项三个值当中最慢的一个，
但从安全性来说，
<code class="docutils literal"><span class="pre">always</span></code> 也是最安全的，
因为即使出现故障停机，
AOF 持久化也只会丢失一个事件循环中所产生的命令数据。</p>
<p>当 <code class="docutils literal"><span class="pre">appendfsync</span></code> 的值为 <code class="docutils literal"><span class="pre">everysec</span></code> 时，
服务器在每个事件循环都要将 <code class="docutils literal"><span class="pre">aof_buf</span></code> 缓冲区中的所有内容写入到 AOF 文件，
并且每隔超过一秒就要在子线程中对 AOF 文件进行一次同步：
从效率上来讲，
<code class="docutils literal"><span class="pre">everysec</span></code> 模式足够快，
并且就算出现故障停机，
数据库也只丢失一秒钟的命令数据。</p>
<p>当 <code class="docutils literal"><span class="pre">appendfsync</span></code> 的值为 <code class="docutils literal"><span class="pre">no</span></code> 时，
服务器在每个事件循环都要将 <code class="docutils literal"><span class="pre">aof_buf</span></code> 缓冲区中的所有内容写入到 AOF 文件，
至于何时对 AOF 文件进行同步，
则由操作系统控制。</p>
<p>因为处于 <code class="docutils literal"><span class="pre">no</span></code> 模式下的 <code class="docutils literal"><span class="pre">flushAppendOnlyFile</span></code> 调用无须执行同步操作，
所以该模式下的 AOF 文件写入速度总是最快的，
不过因为这种模式会在系统缓存中积累一段时间的写入数据，
所以该模式的单次同步时长通常是三种模式中时间最长的：
从平摊操作的角度来看，
<code class="docutils literal"><span class="pre">no</span></code> 模式和 <code class="docutils literal"><span class="pre">everysec</span></code> 模式的效率类似，
当出现故障停机时，
使用 <code class="docutils literal"><span class="pre">no</span></code> 模式的服务器将丢失上次同步 AOF 文件之后的所有写命令数据。</p>
</div>
</div>
</div>



            <div class="section" id="discuss">
    <h2>
        讨论
        <a class="headerlink" href="#discuss" title="永久链接至标题">¶</a>
    </h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'redisbookv1'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../index.html">Redis 设计与实现</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, 黄健宏（huangz）.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.3.
    </div>
  </body>
</html>